<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Tasks.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">tt-cli</a> &gt; <a href="index.source.html" class="el_package">tasktree.spi</a> &gt; <span class="el_source">Tasks.java</span></div><h1>Tasks.java</h1><pre class="source lang-java linenums">package tasktree.spi;

import org.slf4j.Logger;
import tasktree.Configuration;
import tasktree.visitor.PrintTreeVisitor;

import javax.enterprise.context.ApplicationScoped;
import javax.enterprise.inject.Any;
import javax.enterprise.inject.Instance;
import javax.enterprise.inject.spi.Bean;
import javax.enterprise.inject.spi.BeanManager;
import javax.inject.Inject;
import java.util.*;
import java.util.stream.Stream;

@ApplicationScoped
<span class="nc" id="L17">public class Tasks {</span>
<span class="nc" id="L18">    static final ServiceLoader&lt;Task&gt; loader = ServiceLoader.load(Task.class);</span>

    @Inject
    Logger log;

    @Inject
    @Any
    Instance&lt;Task&gt; tasks;

    @Inject
    BeanManager bm;

    @Inject
    Configuration config;

    @Inject
    PrintTreeVisitor visitor;

<span class="nc" id="L36">    Deque&lt;Task&gt; readQueue = new LinkedList&lt;&gt;();</span>
<span class="nc" id="L37">    Deque&lt;Task&gt; writeQueue = new LinkedList&lt;&gt;();</span>

    public static Stream&lt;Task&gt; byProviders() {
<span class="nc" id="L40">        return byProviders(true).stream();</span>
    }

    public static List&lt;Task&gt; byProviders(boolean refresh) {
<span class="nc bnc" id="L44" title="All 2 branches missed.">        if (refresh) {</span>
<span class="nc" id="L45">            loader.reload();</span>
        }
<span class="nc" id="L47">        var result = new ArrayList&lt;Task&gt;();</span>
<span class="nc" id="L48">        loader.iterator().forEachRemaining(result::add);</span>
<span class="nc" id="L49">        return result;</span>
    }


    public Stream&lt;Task&gt; stream() {
<span class="nc" id="L54">        var concat = Stream.concat(byProviders(), byCDI());</span>
<span class="nc" id="L55">        return concat;</span>
    }

    private Stream&lt;Task&gt; byCDI() {
<span class="nc" id="L59">        return tasks.stream();</span>
    }

    public void runAll(String[] args) {
<span class="nc" id="L63">        config.init(args);</span>
<span class="nc" id="L64">        var taskName = config.getTaskName();</span>
<span class="nc" id="L65">        runByName(taskName);</span>
<span class="nc" id="L66">    }</span>

    private void runByName(String taskName) {
<span class="nc" id="L69">        bm.getBeans(taskName)</span>
<span class="nc" id="L70">                .stream()</span>
<span class="nc" id="L71">                .forEach(this::addBean);</span>
<span class="nc" id="L72">        runAll();</span>
<span class="nc" id="L73">    }</span>

    private void addBean(Bean&lt;?&gt; bean) {
<span class="nc" id="L76">        var ctx = bm.createCreationalContext(bean);</span>
<span class="nc" id="L77">        var ref = bm.getReference(bean, bean.getBeanClass(), ctx);</span>
<span class="nc bnc" id="L78" title="All 2 branches missed.">        if (ref instanceof Task task) {</span>
<span class="nc" id="L79">            addTask((Task) task);</span>
        }else{
<span class="nc" id="L81">            log.error(&quot;Bean {} is not a Task&quot;, bean);</span>
        }
<span class="nc" id="L83">    }</span>

    private void printTasks(List&lt;Task&gt; tasks) {
<span class="nc" id="L86">        tasks.stream().map(Task::getName).forEach(log::debug);</span>
<span class="nc" id="L87">        return;</span>
    }

    private void addAll(List&lt;Task&gt; tasks) {
<span class="nc" id="L91">        tasks.forEach(this::addTask);</span>
<span class="nc" id="L92">    }</span>

    public void addTask(Task task) {
<span class="nc bnc" id="L95" title="All 2 branches missed.">        if (task.isWrite()) {</span>
<span class="nc" id="L96">            writeQueue.addFirst(task);</span>
        }else {
<span class="nc" id="L98">            readQueue.addLast(task);</span>
        }
<span class="nc" id="L100">        trace(&quot;Added&quot;, task);</span>
<span class="nc" id="L101">    }</span>

    static final String LOG_FORMAT = &quot;{} [{}] [R {}/W {}]&quot;;

    private void trace(String message, Task task) {
<span class="nc" id="L106">        log.trace(LOG_FORMAT,</span>
                message,
                task,
<span class="nc" id="L109">                readQueue.size() ,</span>
<span class="nc" id="L110">                writeQueue.size());</span>
<span class="nc" id="L111">    }</span>

    private void debug(String message, Task task) {
<span class="nc" id="L114">        log.debug(LOG_FORMAT,</span>
                message,
                task,
<span class="nc" id="L117">                readQueue.size() ,</span>
<span class="nc" id="L118">                writeQueue.size());</span>
<span class="nc" id="L119">    }</span>

    private void info(String message, Task task) {
<span class="nc" id="L122">        log.info(LOG_FORMAT,</span>
                message,
                task,
<span class="nc" id="L125">                readQueue.size(),</span>
<span class="nc" id="L126">                writeQueue.size());</span>
<span class="nc" id="L127">    }</span>

    private void runAll() {
<span class="nc" id="L130">        log.debug(&quot;Processing read task queue&quot;);</span>
<span class="nc" id="L131">        runReads();</span>
<span class="nc" id="L132">        log.debug(&quot;Processing write task queue [dryRun={}]&quot;, config.isDryRun());</span>
<span class="nc" id="L133">        runWrites();</span>
<span class="nc" id="L134">        log.debug(&quot;Task queues empty. Done!&quot;);</span>
<span class="nc" id="L135">    }</span>

    private void runWrites() {
<span class="nc bnc" id="L138" title="All 2 branches missed.">        while (!writeQueue.isEmpty()) {</span>
<span class="nc" id="L139">            var task = writeQueue.pop();</span>
<span class="nc" id="L140">            config.waitBeforeRun();</span>
<span class="nc" id="L141">            runTask(task);</span>
<span class="nc" id="L142">        }</span>
<span class="nc" id="L143">    }</span>

    private void runReads() {
<span class="nc bnc" id="L146" title="All 2 branches missed.">        while (!readQueue.isEmpty()) {</span>
<span class="nc" id="L147">            var task = readQueue.pop();</span>
<span class="nc" id="L148">            config.waitBeforeRun();</span>
<span class="nc" id="L149">            runTask(task);</span>
<span class="nc" id="L150">        }</span>
<span class="nc" id="L151">    }</span>

    private void runTask(Task task) {
<span class="nc" id="L154">        var isWrite = task.isWrite();</span>
<span class="nc bnc" id="L155" title="All 4 branches missed.">        if (isWrite &amp;&amp; config.isDryRun()){</span>
<span class="nc" id="L156">            info(&quot;Skipped [dry run]&quot;, task);</span>
<span class="nc" id="L157">            return;</span>
        }
<span class="nc" id="L159">        tryRun(task);</span>
<span class="nc" id="L160">    }</span>

    private void
    tryRun(Task task) {
        try {
<span class="nc" id="L165">            task.runSafe();</span>
<span class="nc" id="L166">            debug(&quot;Executed&quot;, task);</span>
<span class="nc" id="L167">        }catch (Throwable ex) {</span>
            //ex.printStackTrace();
<span class="nc" id="L169">            int retries = task.getRetries();</span>
<span class="nc bnc" id="L170" title="All 2 branches missed.">            if (retries &gt; 0) {</span>
<span class="nc" id="L171">                debug(&quot;Re-queued [%s]&quot;.formatted(ex.getMessage()), task);</span>
<span class="nc" id="L172">                task.retried();</span>
<span class="nc" id="L173">                addTask(task);</span>
            }else {
<span class="nc" id="L175">                debug(&quot;Failed&quot;, task);</span>
                //log.error(ex.getMessage(),ex);
            }
<span class="nc" id="L178">        }</span>
<span class="nc" id="L179">    }</span>

    private boolean match(Task p) {
<span class="nc" id="L182">        var match = p.filter(config.getTaskName());</span>
<span class="nc" id="L183">        return match;</span>
    }


}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>